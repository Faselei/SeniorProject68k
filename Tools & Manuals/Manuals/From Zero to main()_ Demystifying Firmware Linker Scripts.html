<!DOCTYPE html>
<html>

<head>
  <!-- Meta -->
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="referrer" content="no-referrer-when-downgrade">
  <meta name="title" content="From Zero to main(): Demystifying Firmware Linker Scripts">
  <meta property="og:title" content="From Zero to main(): Demystifying Firmware Linker Scripts">
  <meta property="og:description" content="A community and blog for embedded software makers">

  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>From Zero to main(): Demystifying Firmware Linker Scripts | Interrupt</title>
<meta name="generator" content="Jekyll v4.2.1" />
<meta property="og:title" content="From Zero to main(): Demystifying Firmware Linker Scripts" />
<meta name="author" content="François Baldassari" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="An in depth tutorial on how to write linker scripts for firmware projects" />
<meta property="og:description" content="An in depth tutorial on how to write linker scripts for firmware projects" />
<link rel="canonical" href="https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware" />
<meta property="og:url" content="https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware" />
<meta property="og:site_name" content="Interrupt" />
<meta property="og:image" content="https://interrupt.memfault.com/img/interrupt-cover-1200px.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-06-25T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://interrupt.memfault.com/img/interrupt-cover-1200px.png" />
<meta property="twitter:title" content="From Zero to main(): Demystifying Firmware Linker Scripts" />
<meta name="google-site-verification" content="2qyLRd8BiI5o3XnqssLvbzPDJ-2S6ytb9iLoNoz1Z9M" />
<script type="application/ld+json">
{"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://interrupt.memfault.com/img/interrupt-logo-1200px.png"},"name":"François Baldassari"},"author":{"@type":"Person","name":"François Baldassari"},"description":"An in depth tutorial on how to write linker scripts for firmware projects","image":"https://interrupt.memfault.com/img/interrupt-cover-1200px.png","@type":"BlogPosting","headline":"From Zero to main(): Demystifying Firmware Linker Scripts","dateModified":"2019-06-25T00:00:00+00:00","datePublished":"2019-06-25T00:00:00+00:00","url":"https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware","mainEntityOfPage":{"@type":"WebPage","@id":"https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->


  <!-- Google Tag Manager -->
  <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer','GTM-PDMNKRX');</script>
  <!-- End Google Tag Manager -->

  <title>From Zero to main(): Demystifying Firmware Linker Scripts</title>
  <link rel="icon" href="/img/favicon.png" type="image/png" />

  <!-- CSS & fonts -->
  <link rel="stylesheet" href="/css/main.css">
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400%7CSource+Sans+Pro:300,400,700,900,400italic%7CSignika:700,300,400,600' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <!-- RSS -->
  <link href="https://interrupt.memfault.com/feed.xml" type="application/rss+xml" rel="alternate" title="RSS 2.0 Feed" />

</head>


<body>
	<div id="wrap">

	  	<!-- Navigation -->
	  	<nav id="nav">
	<div id="nav-list">
		<a href="/">Home</a>
		<a href="/blog" title="Blog">Blog</a>

		<!-- Nav pages -->
	  
	    
	  
	    
	      <a href="/about" title="About">About</a>
	    
	  
	    
	      <a href="/authors" title="Authors">Authors</a>
	    
	  
	    
	      <a href="/code-of-conduct" title="Code of Conduct">Code of Conduct</a>
	    
	  
	    
	      <a href="/contributing" title="Contributing">Contributing</a>
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	      <a href="/tags" title="Tags">Tags</a>
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  
	    
	  

    <!-- Nav links -->
	  <!-- TODO <a id="theme-toggle" href="#">Toggle dark mode</a> -->
<a href="/jobs">Jobs</a>
<a href="/events">Events</a>
<a href="https://github.com/memfault/interrupt" target="_blank">Github</a>
<a href="https://memfault.com" target="_blank">About Memfault</a>

	</div>

  <!-- Nav footer -->
  <footer>
	
	<!-- Your custom nav footer here -->
	
</footer>

</nav>


    <!-- Icon menu -->
	  <a id="nav-menu">
	  	<div id="menu"></div>
	  </a>

      <!-- Header -->
      <header id="header">
  <a href="/">
    <img id="logo" src="/img/interrupt-logo.svg" alt="Interrupt Logo">
    <h1>Interrupt</h1>
  </a>
  <br>
  <a href="/feed.xml">
    <svg class="svg-icon rss"><use xlink:href="/img/social-icons.svg#rss"></use></svg><span>RSS</span>
  </a>    
  <a href="https://go.memfault.com/interrupt-subscribe" target="_blank">Subscribe</a>    
  <a href="/contributing">Contribute</a>    
  <a href="/tags">Tags</a>  
  <a href="https://interrupt-slack.herokuapp.com/" target="_blank">
    <svg class="svg-icon slack"><use xlink:href="/img/social-icons.svg#slack"></use></svg><span>Slack</span>
  </a>    
  <a href="/jobs">Jobs</a>    
  <a href="/events">Events</a>    
</header>


    <!-- Main content -->
	  <div id="split-container-wrapper">
      <div id="split-container">
        <main>

          <article id="post-page">
    
    

    <script src="/js/anchor.min.js"></script>
    <h2>From Zero to main(): Demystifying Firmware Linker Scripts</h2>
    <div class="by-line">
       <time datetime="2019-06-25T00:00:00+00:00">25 Jun 2019</time>
       
       <span>by <a href="/authors/francois">François Baldassari</a></span>
       
    </div>
    <div class="content">

        <p>This is the second post in our <a href="/tag/zero-to-main">Zero to main() series</a>.</p>

<!-- excerpt start -->

<p><a href="/blog/zero-to-main-1">Last time</a>, we talked about
bootstrapping a C environment on an MCU before invoking our <code class="language-plaintext highlighter-rouge">main</code> function. One
thing we took for granted was the fact that functions and data end up in the
right place in our binary. Today, we’re going to dig into how that happens by
learning about memory regions and linker scripts.</p>

<!-- excerpt end -->

<p>You may remember the following things happening auto-magically:</p>

<ol>
  <li>We used variables like <code class="language-plaintext highlighter-rouge">&amp;_ebss</code>, <code class="language-plaintext highlighter-rouge">&amp;_sdata</code>, …etc. to know where each of our
sections was placed in flash and to define where some needed to go in RAM.</li>
  <li>A pointer to our <code class="language-plaintext highlighter-rouge">ResetHandler</code> was found at address 0x00000004 for the MCU
to find.</li>
</ol>

<p>While these things are true for many projects, they are held together at best by
convention, at worst by generations of copy/paste engineering. You’ll find some
MCUs have different memory maps, some startup scripts name those variables
differently, and some programs have more or less segments.</p>

<p>Since they are not standardized, those things need to be specified somewhere in
our project. In the case of projects linked with a Unix-<code class="language-plaintext highlighter-rouge">ld</code>-like tool, that
somewhere is the linker script.</p>

<p>Once again, we will use our simple “minimal” program, available <a href="https://github.com/memfault/zero-to-main/blob/master/minimal" target="_blank">on
Github</a>.</p>

<div class="newsletter">
  <p class="newsletter-content">Like Interrupt? <a class="newsletter-link" href="https://go.memfault.com/interrupt-subscribe" target="_blank">Subscribe</a> to get our latest posts straight to your mailbox.</p>
</div>

<h2 id="brief-primer-on-linking">Brief Primer on Linking</h2>

<p>Linking is the last stage in compiling a program. It takes a number of compiled
object files and merges them into a single program, filling in addresses so
that everything is in the right place.</p>

<p>Prior to linking, the compiler will have taken your source files one by one and compiled
them into machine code. In the process, it leaves placeholders for
addresses as (1) it does not know where the code will end up within the broader
structure of the program and (2) it knows nothing about symbols outside of the
current file or compilation unit.</p>

<p>The linker takes all of those object files and merges them together along with
external dependencies like the C Standard Library into your program. To figure
out which bits go where, the linker relies on a linker script - a blueprint for
your program. Lastly, all placeholders are replaced by addresses.</p>

<p>We can see this at play in our minimal program. Let’s follow what happens to
our <code class="language-plaintext highlighter-rouge">main</code> function in <code class="language-plaintext highlighter-rouge">minimal.c</code> for example. The compiler builds it into
an object file with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-gcc -c -o build/objs/a/b/c/minimal.o minimal.c &lt;CFLAGS&gt;
</code></pre></div></div>

<p>We can dump symbols in <code class="language-plaintext highlighter-rouge">minimal.o</code> to look at <code class="language-plaintext highlighter-rouge">main</code> within it:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-nm build/objs/a/b/c/minimal.o
...
00000000 T main
...
</code></pre></div></div>

<p>As expected, it does not have addresses yet. We then link everything with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-gcc &lt;LDFLAGS&gt; build/objs/a/b/c/minimal.o &lt;other object files&gt; -o build/minimal.elf
</code></pre></div></div>

<p>And dump the symbols in the resulting <code class="language-plaintext highlighter-rouge">elf</code> file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-nm build/minimal.elf
...
00000294 T main
...
</code></pre></div></div>

<p>The linker has done its job, and our <code class="language-plaintext highlighter-rouge">main</code> symbol has been assigned an address.</p>

<p>The linker often does a bit more than that. For example, it can generate debug
information, garbage collect unused sections of code, or run whole-program
optimization (also known as Link-Time Optimization, or LTO). For the sake of
this conversation, we will not cover these topics.</p>

<p>For more information on the linker, there’s a great thread on <a href="https://stackoverflow.com/questions/3322911/what-do-linkers-do" target="_blank">Stack
Overflow</a>.</p>

<h2 id="anatomy-of-a-linker-script">Anatomy of a Linker Script</h2>

<p>A linker script contains four things:</p>

<ul>
  <li>Memory layout: what memory is available where</li>
  <li>Section definitions: what part of a program should go where</li>
  <li>Options: commands to specify architecture, entry point, …etc. if needed</li>
  <li>Symbols: variables to inject into the program at link time</li>
</ul>

<h2 id="memory-layout">Memory Layout</h2>

<p>In order to allocate program space, the linker needs to know how much memory is
available, and at what addresses that memory exists. This is what the <code class="language-plaintext highlighter-rouge">MEMORY</code>
definition in the linker script is for.</p>

<p>The syntax for MEMORY is defined in the <a href="https://sourceware.org/binutils/docs/ld/MEMORY.html#MEMORY" target="_blank">binutils
docs</a> and is as follow:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MEMORY
  {
    name [(attr)] : ORIGIN = origin, LENGTH = len
    …
  }
</code></pre></div></div>

<p>Where</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">name</code> is a name you want to use for this region. Names do not carry meaning,
so you’re free to use anything you want. You’ll often find “flash”, and “ram”
as region names.</li>
  <li>
<code class="language-plaintext highlighter-rouge">(attr)</code> are optional attributes for the region, like whether it’s writable
(<code class="language-plaintext highlighter-rouge">w</code>), readable (<code class="language-plaintext highlighter-rouge">r</code>), or executable (<code class="language-plaintext highlighter-rouge">x</code>). Flash memory is usually <code class="language-plaintext highlighter-rouge">(rx)</code>,
while ram is <code class="language-plaintext highlighter-rouge">rwx</code>. Marking a region as non-writable does not magically make it
write protected: these attributes are meant to describe the properties of the
memory, not set it.</li>
  <li>
<code class="language-plaintext highlighter-rouge">origin</code> is the start address of the memory region.</li>
  <li>
<code class="language-plaintext highlighter-rouge">len</code> is the size of the memory region, in bytes.</li>
</ul>

<p>The memory map for the SAMD21G18 chip we’ve got on our board can be found in its
<a href="http://ww1.microchip.com/downloads/en/DeviceDoc/SAMD21-Family-DataSheet-DS40001882D.pdf" target="_blank">datasheet</a>
in table 10-1, reproduced below.</p>

<table align="center" border="0" summary="SAMD21G18 Memory map">
<caption>SAMD21G18 Memory Map</caption>
    <thead xmlns="http://www.w3.org/1999/xhtml">
        <tr>
<th>Memory</th>
<th>Start Address</th>
<th>Size</th>
</tr>
    </thead>
    <tbody xmlns="http://www.w3.org/1999/xhtml">
        <tr>
            <td>Internal Flash</td>
            <td>0x00000000</td>
            <td>256 Kbytes</td>
        </tr>
        <tr>
            <td>Internal SRAM</td>
            <td>0x20000000</td>
            <td>32 Kbytes</td>
        </tr>
    </tbody>
</table>
<p><br></p>

<p>Transcribed into a <code class="language-plaintext highlighter-rouge">MEMORY</code> definition, this gives us:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MEMORY
{
  rom      (rx)  : ORIGIN = 0x00000000, LENGTH = 0x00040000
  ram      (rwx) : ORIGIN = 0x20000000, LENGTH = 0x00008000
}
</code></pre></div></div>

<h2 id="section-definitions">Section Definitions</h2>

<p>Code and data are bucketed into sections, which are contiguous areas of memory.
There are no hard rules about how many sections you should have, or what they
should be, but you typically want to put symbols in the same section if:</p>

<ol>
  <li>They should be in the same region of memory, or</li>
  <li>They need to be initialized together.</li>
</ol>

<p>In our previous post, we learned about two types of symbols that are initialized
in bulk:</p>

<ol>
  <li>Initialized static variables which must be copied from flash</li>
  <li>Uninitialized static variables which must be zeroed.</li>
</ol>

<p>Our linker script concerns itself with two more things:</p>

<ol>
  <li>Code and constant data, which can live in read-only memory (e.g. flash)</li>
  <li>Reserved sections of RAM, like a stack or a heap</li>
</ol>

<p>By convention, we name those sections as follow:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">.text</code> for code &amp; constants</li>
  <li>
<code class="language-plaintext highlighter-rouge">.bss</code> for uninitialized data</li>
  <li>
<code class="language-plaintext highlighter-rouge">.stack</code> for our stack</li>
  <li>
<code class="language-plaintext highlighter-rouge">.data</code> for initialized data</li>
</ol>

<p>The <a href="http://refspecs.linuxbase.org/elf/elf.pdf" target="_blank">elf spec</a> holds a full list.
Your firmware will work just fine if you call them anything else, but your
colleagues may be confused and some tools may fail in odd ways. The only
constraint is that you may not call your section <code class="language-plaintext highlighter-rouge">/DISCARD/</code>, which is a
reserved keyword.</p>

<p>First, let’s look at what happens to our symbols if we do not define any of
those sections in the linker script.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MEMORY
{
  rom      (rx)  : ORIGIN = 0x00000000, LENGTH = 0x00040000
  ram      (rwx) : ORIGIN = 0x20000000, LENGTH = 0x00008000
}

SECTIONS
{
    /* empty! */
}
</code></pre></div></div>

<p>The linker is perfectly happy to link our program with this. Probing the
resulting elf file with objdump, we see the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-objdump -h build/minimal.elf
build/minimal.elf:     file format elf32-littlearm

SYMBOL TABLE:
no symbols
</code></pre></div></div>

<p>No symbols! While the linker is able to make assumptions that will allow it to
link in symbols with little information, but it at least needs to know either
what the entry point should be, or what symbols to put in the text section.</p>

<h3 id="text-section">
<code class="language-plaintext highlighter-rouge">.text</code> Section</h3>

<p>Let’s start by adding our <code class="language-plaintext highlighter-rouge">.text</code> section. We want that section in ROM. The
syntax is simple:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SECTIONS
{
    .text :
    {

    } &gt; rom
}
</code></pre></div></div>

<p>This defines a section named <code class="language-plaintext highlighter-rouge">.text</code>, and adds it to the ROM. We now need to
tell the linker what to put in that section. This is accomplished by listing all
of the sections from our input object files we want in <code class="language-plaintext highlighter-rouge">.text</code>.</p>

<p>To find out what sections are in our object file, we can once again use
<code class="language-plaintext highlighter-rouge">objdump</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ arm-none-eabi-objdump -h
build/objs/a/b/c/minimal.o:     file format elf32-littlearm

Sections:
Idx Name          Size      VMA       LMA       File off  Algn
  0 .text         00000000  00000000  00000000  00000034  2**1
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  1 .data         00000000  00000000  00000000  00000034  2**0
                  CONTENTS, ALLOC, LOAD, DATA
  2 .bss          00000000  00000000  00000000  00000034  2**0
                  ALLOC
  3 .bss.cpu_irq_critical_section_counter 00000004  00000000  00000000  00000034
2**2
                  ALLOC
  4 .bss.cpu_irq_prev_interrupt_state 00000001  00000000  00000000  00000034
2**0
                  ALLOC
  5 .text.system_pinmux_get_group_from_gpio_pin 0000005c  00000000  00000000
00000034  2**2
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  6 .text.port_get_group_from_gpio_pin 00000020  00000000  00000000  00000090
2**1
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  7 .text.port_get_config_defaults 00000022  00000000  00000000  000000b0  2**1
                  CONTENTS, ALLOC, LOAD, READONLY, CODE
  8 .text.port_pin_set_output_level 0000004e  00000000  00000000  000000d2  2**1
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
  9 .text.port_pin_toggle_output_level 00000038  00000000  00000000  00000120
2**1
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
 10 .text.set_output 00000040  00000000  00000000  00000158  2**1
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
 11 .text.main    0000002c  00000000  00000000  00000198  2**2
                  CONTENTS, ALLOC, LOAD, RELOC, READONLY, CODE
</code></pre></div></div>

<p>We see that each of our symbol has a section. This is due to the fact
that we compiled our firmware with the <code class="language-plaintext highlighter-rouge">-ffunction-sections</code> and <code class="language-plaintext highlighter-rouge">-fdata-sections</code> flags.
Had we not included them, the compiler would have been free to merge several
functions into a single <code class="language-plaintext highlighter-rouge">text.&lt;some identifier&gt;</code> section.</p>

<p>To put all of our functions in the <code class="language-plaintext highlighter-rouge">.text</code> section in our linker script, we use
the following syntax: <code class="language-plaintext highlighter-rouge">&lt;filename&gt;(&lt;section&gt;)</code>, where <code class="language-plaintext highlighter-rouge">filename</code> is the
name of the input files whose symbols we want to include, and <code class="language-plaintext highlighter-rouge">section</code> is the
name of the input sections. Since we want all <code class="language-plaintext highlighter-rouge">.text...</code> sections in all files,
we use the wildcard <code class="language-plaintext highlighter-rouge">*</code>:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.text :
{
    KEEP(*(.vector*))
    *(.text*)
} &gt; rom
</code></pre></div></div>

<p>Note the <code class="language-plaintext highlighter-rouge">.vector</code> input section, which contains functions we want to keep at
the very start of our <code class="language-plaintext highlighter-rouge">.text</code> section. This is so the <code class="language-plaintext highlighter-rouge">Reset_Handler</code> is where the MCU
expects it to be. We’ll talk more about the vector table in a future post.</p>

<p>Dumping our elf file, we now see all of our functions (but no data)!</p>

<div class="language-terminal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>arm-none-eabi-objdump <span class="nt">-t</span> build/minimal.elf
<span class="go">
build/minimal.elf:     file format elf32-littlearm

SYMBOL TABLE:
00000000 l    d  .text  00000000 .text
</span><span class="c">...
</span><span class="go">00000000 l    df *ABS*  00000000 minimal.c
00000000 l     F .text  0000005c system_pinmux_get_group_from_gpio_pin
0000005c l     F .text  00000020 port_get_group_from_gpio_pin
0000007c l     F .text  00000022 port_get_config_defaults
0000009e l     F .text  0000004e port_pin_set_output_level
000000ec l     F .text  00000038 port_pin_toggle_output_level
00000124 l     F .text  00000040 set_output
00000000 l    df *ABS*  00000000 port.c
00000190 l     F .text  00000028 system_pinmux_get_config_defaults
00000000 l    df *ABS*  00000000 pinmux.c
00000208 l     F .text  0000005c system_pinmux_get_group_from_gpio_pin
00000264 l     F .text  00000110 _system_pinmux_config
00000164 g     F .text  0000002c main
000001b8 g     F .text  0000004e port_pin_set_config
00000374 g     F .text  00000040 system_pinmux_pin_set_config
</span><span class="c">...
</span></code></pre></div></div>

<h3 id="bss-section">
<code class="language-plaintext highlighter-rouge">.bss</code> Section</h3>

<p>Now, let’s take care of our <code class="language-plaintext highlighter-rouge">.bss</code>. Remember, this is the section we put
uninitialized static memory in. <code class="language-plaintext highlighter-rouge">.bss</code> must be reserved in the memory map, but there
is nothing to load, as all variables are initialized to zero. As such, this is
what it should look like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SECTION {
    ...
    .bss (NOLOAD) :
    {
        *(.bss*)
        *(COMMON)
    } &gt; ram
}
</code></pre></div></div>

<p>You’ll note that the <code class="language-plaintext highlighter-rouge">.bss</code> section also includes <code class="language-plaintext highlighter-rouge">*(COMMON)</code>. This is a
special input section where the compiler puts global uninitialized variables that
go beyond file scope. <code class="language-plaintext highlighter-rouge">int foo;</code> goes there, while <code class="language-plaintext highlighter-rouge">static int foo;</code> does not.
This allows the linker to merge multiple definitions into one symbol if they
have the same name.</p>

<p>We indicate that this section is not loaded with the <code class="language-plaintext highlighter-rouge">NOLOAD</code> property. This is
the only section property used in modern linker scripts.</p>

<h3 id="stack-section">
<code class="language-plaintext highlighter-rouge">.stack</code> Section</h3>

<p>We do the same thing for our <code class="language-plaintext highlighter-rouge">.stack</code> memory, since it is in RAM and not loaded.
As the stack contains no symbols, we must explicitly reserve space for it by
indicating its size. We also must align the stack on an 8-byte boundary per ARM
Procedure Call Standards
(<a href="https://static.docs.arm.com/ddi0403/ec/DDI0403E_c_armv7m_arm.pdf" target="_blank">AAPCS</a>).</p>

<p>In order to achieve these goals, we turn to a special variable <code class="language-plaintext highlighter-rouge">.</code>, also known
as the “location counter”. The location counter tracks the current offset into a
given memory region. As sections are added, the location counter increments
accordingly. You can force alignment or gaps by setting the location counter
forward. You may not set it backwards, and the linker will throw an error if you
try.</p>

<p>We set the location counter with the <code class="language-plaintext highlighter-rouge">ALIGN</code> function, to align the section, and
use simple assignment and arithmetic to set the section size:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STACK_SIZE = 0x2000; /* 8 kB */

SECTION {
    ...
    .stack (NOLOAD) :
    {
        . = ALIGN(8);
        . = . + STACK_SIZE;
        . = ALIGN(8);
    } &gt; ram
    ...
}
</code></pre></div></div>

<p>Only one more section to go!</p>

<h3 id="data-section">
<code class="language-plaintext highlighter-rouge">.data</code> Section</h3>

<p>The <code class="language-plaintext highlighter-rouge">.data</code> section contains static variables which have an
initial value at boot. You will remember from our previous article that since RAM
isn’t persisted while power is off, those sections need to be loaded from flash.
At boot, the <code class="language-plaintext highlighter-rouge">Reset_Handler</code> copies the data from flash to RAM before the <code class="language-plaintext highlighter-rouge">main</code>
function is called.</p>

<p>To make this possible, every section in our linker script has two addresses,
its <em>load</em> address (LMA) and its <em>virtual</em> address (VMA). In a firmware context,
the LMA is where your JTAG loader needs to place the section and the VMA is
where the section is found during execution.</p>

<p>You can think of the LMA as the address “at rest” and the VMA the address during
execution i.e. when the device is on and the program is running.</p>

<p>The syntax to specify the LMA and VMA is relatively straightforward: every address is
two part: <vma> AT <lma>. In our case it looks like this:</lma></vma></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.data :
{
    *(.data*);
} &gt; ram AT &gt; rom  /* "&gt; ram" is the VMA, "&gt; rom" is the LMA */
</code></pre></div></div>

<p>Note that instead of appending a section to a memory region, you could also explicitly
specify an address like so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.data ORIGIN(ram) /* VMA */ : AT(ORIGIN(rom)) /* LMA */
{
    . = ALIGN(4);
    _sdata = .;
    *(.data*);
    . = ALIGN(4);
    _edata = .;
}
</code></pre></div></div>

<p>Where <code class="language-plaintext highlighter-rouge">ORIGIN(&lt;region&gt;)</code> is a simple way to specify the start of a region. You
can enter an address in hex as well.</p>

<p>And we’re done! Here’s our complete linker script with every section:</p>

<h3 id="complete-linker-script">Complete Linker Script</h3>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MEMORY
{
  rom      (rx)  : ORIGIN = 0x00000000, LENGTH = 0x00040000
  ram      (rwx) : ORIGIN = 0x20000000, LENGTH = 0x00008000
}

STACK_SIZE = 0x2000;

/* Section Definitions */
SECTIONS
{
    .text :
    {
        KEEP(*(.vectors .vectors.*))
        *(.text*)
        *(.rodata*)
    } &gt; rom

    /* .bss section which is used for uninitialized data */
    .bss (NOLOAD) :
    {
        *(.bss*)
        *(COMMON)
    } &gt; ram

    .data :
    {
        *(.data*);
    } &gt; ram AT &gt;rom

    /* stack section */
    .stack (NOLOAD):
    {
        . = ALIGN(8);
        . = . + STACK_SIZE;
        . = ALIGN(8);
    } &gt; ram

    _end = . ;
}
</code></pre></div></div>

<p>You can find the full details on linker script sections syntax in the
<a href="https://sourceware.org/binutils/docs/ld/SECTIONS.html#SECTIONS" target="_blank">ld
manual</a>.</p>

<h2 id="variables">Variables</h2>

<p>In the first post, our <code class="language-plaintext highlighter-rouge">ResetHandler</code> relied on seemingly magic variables to know
the address of each of our sections of memory. It turns out, those variable came</p>

<p>In order to make section addresses available to code, the linker is able
to generate symbols and add them to the program.</p>

<p>You can find the syntax in the <a href="https://sourceware.org/binutils/docs/ld/Simple-Assignments.html#Simple-Assignments" target="_blank">linker
documentation</a>,
it looks exactly like a C assignment: <code class="language-plaintext highlighter-rouge">symbol = expression;</code></p>

<p>Here, we need:</p>

<ol>
  <li>
<code class="language-plaintext highlighter-rouge">_etext</code> the end of the code in <code class="language-plaintext highlighter-rouge">.text</code> section in flash.</li>
  <li>
<code class="language-plaintext highlighter-rouge">_sdata</code> the start of the <code class="language-plaintext highlighter-rouge">.data</code> section in RAM</li>
  <li>
<code class="language-plaintext highlighter-rouge">_edata</code> the end of the <code class="language-plaintext highlighter-rouge">.data</code> section in RAM</li>
  <li>
<code class="language-plaintext highlighter-rouge">_sbss</code> the start of the <code class="language-plaintext highlighter-rouge">.bss</code> section in RAM</li>
  <li>
<code class="language-plaintext highlighter-rouge">_ebss</code> the end of the <code class="language-plaintext highlighter-rouge">.bss</code> section in RAM</li>
</ol>

<p>They are all relatively straightforward: we can assign our symbols to the value
of the location counter (<code class="language-plaintext highlighter-rouge">.</code>) at the start and at the end of each section
definition.</p>

<p>The code is below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    .text :
    {
        KEEP(*(.vectors .vectors.*))
        *(.text.*)
        *(.rodata.*)
        _etext = .;
    } &gt; rom

    .bss (NOLOAD) :
    {
        _sbss = . ;
        *(.bss .bss.*)
        *(COMMON)
        _ebss = . ;
    } &gt; ram

    .data :
    {
        _sdata = .;
        *(.data*);
        _edata = .;
    } &gt; ram AT &gt;rom
</code></pre></div></div>

<p>One quirk of these linker-provided symbols: you must use a reference to
them, never the variable themselves. For example, the following gets us a
pointer to the start of the <code class="language-plaintext highlighter-rouge">.data</code> section:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">data_byte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_sdata</span><span class="p">;</span>
</code></pre></div></div>

<p>You can read more details about this in the <a href="https://sourceware.org/binutils/docs/ld/Source-Code-Reference.html" target="_blank">binutils
docs</a>.</p>

<h2 id="closing">Closing</h2>

<p>I hope this post gave you confidence in writing your own linker scripts.</p>

<p>In my next post, we’ll talk about writing a bootloader to assist with loading
and starting your application.</p>

<p><em>EDIT: Post written!</em> - <a href="/blog/how-to-write-a-bootloader-from-scratch">Writing a Bootloader from Scratch</a></p>

<p>As with previous posts, code examples are available on Github in the <a href="https://github.com/memfault/zero-to-main" target="_blank">zero to main
repository</a></p>

<div class="submit-pr">
  <p class="submit-pr-content">See anything you'd like to change? Submit a pull request or open an issue at <a class="submit-pr-link" href="https://github.com/memfault/interrupt" target="_blank">GitHub</a></p>
</div>

<div class="newsletter">
  <p class="newsletter-content">Like Interrupt? <a class="newsletter-link" href="https://go.memfault.com/interrupt-subscribe" target="_blank">Subscribe</a> to get our latest posts straight to your mailbox.</p>
</div>



    </div>

    
        <div class="author">
            
            <img src="/img/author/francois.jpg">
            
            <span>
                <a href="/authors/francois">François Baldassari</a> has worked on the embedded software teams at Sun, Pebble, and Oculus. He is currently the CEO of <a href="https://memfault.com" target="_blank">Memfault</a>.<br>
                
<span>
    
    <a href="https://twitter.com/baldassarifr" target="_blank"><svg class="svg-icon twitter"><use xlink:href="/img/social-icons.svg#twitter"></use></svg></a>
    
    
    <a href="https://www.linkedin.com/in/francois-baldassari" target="_blank"><svg class="svg-icon linkedin"><use xlink:href="/img/social-icons.svg#linkedin"></use></svg></a>
    
    
    <a href="https://github.com/franc0is" target="_blank"><svg class="svg-icon github"><use xlink:href="/img/social-icons.svg#github"></use></svg></a>
    
</span>

            </span>

        </div>
    

    <div id="discourse-comments"></div>
</article>
<script type="text/javascript">
    DiscourseEmbed = { discourseUrl: 'https://community.memfault.com/',
        discourseEmbedUrl: 'https://interrupt.memfault.com/blog/how-to-write-linker-scripts-for-firmware' };

    (function() {
        var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
        d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
    })();
    anchors.options.visible = 'hover';
    anchors.add('.post-content > h1, h2, h3, h4, h5, h6');
</script>



        </main>
        <aside>
          <!-- HTML elements for search -->
<form id="search-form">
  <label for="search-input">
    <h3>Search</h3>
  </label>
  <input type="text" id="search-input" placeholder="Search posts..">
</form>
<ul id="results-container"></ul>

<!-- or without installing anything -->
<script src="/js/simple-jekyll-search.min.js"></script>

<script>
  window.simpleJekyllSearch = new SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('results-container'),
    json: "/search.json",
    searchResultTemplate: '<li><a href="{url}?query={query}" title="{title}">{title}</a></li>',
    noResultsText: 'No results found',
    limit: 10,
    fuzzy: false
  })
</script>

          <!--[if lte IE 8]>

<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2-legacy.js"></script>
<![endif]-->

<script charset="utf-8" type="text/javascript" src="//js.hsforms.net/forms/v2.js"></script>
<script> hbspt.forms.create({ portalId: "8551838", formId: "a61bb5a0-4339-4398-b639-c0894f961532" });
</script>
          



<div class="memfault-info-wrapper">
    <h3 class="">Featured Events</h3>
    
        <p>
            <a href="https://go.memfault.com/how-to-monitor-debug-update-your-android-os-devices-webinar" target="_blank">How to monitor, debug &amp; update Embedded Android devices with Memfault</a>
        </p>
    
        <p>
            <a href="https://webinars.nordicsemi.com/introducing-nrf-connect-for-vs-code" target="_blank">Introducing nRF Connect for VS Code</a>
        </p>
    
    <p>
        <a href="/events">
            All events
        <img class="chevron-icon" src="/img/chevron-right.svg">
        </a>
    </p>
</div>

<div class="memfault-info-wrapper">
    <p>
        <img class="mf-icon" src="/img/memfault-logo.png">
        Brought to you with <span style="font-size: 10px;">❤️</span> by Memfault.
        <br>
        <a href="https://memfault.com/" target="_blank">
            Learn more
            <img class="chevron-icon" src="/img/chevron-right.svg">
        </a>
    </p>
</div>
<div class="share-buttons-wrapper">
    <h3>Share on: </h3>
    <div id="share-buttons">
        <div class="facebook" title="Share this on Facebook" onclick="window.open(`http://www.facebook.com/share.php?u=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware`);">
            <svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
                <path fill="inherit" d="M1343 12v264h-157q-86 0-116 36t-30 108v189h293l-39 296h-254v759h-306v-759h-255v-296h255v-218q0-186 104-288.5t277-102.5q147 0 228 12z"></path>
            </svg>
        </div>

        <div class="twitter" title="Share this on Twitter" onclick="window.open(`https://twitter.com/share?url=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware&amp;text=From%20Zero%20to%20main()%3A%20Demystifying%20Firmware%20Linker%20Scripts`);">
            <svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
                <path d="M1684 408q-67 98-162 167 1 14 1 42 0 130-38 259.5t-115.5 248.5-184.5 210.5-258 146-323 54.5q-271 0-496-145 35 4 78 4 225 0 401-138-105-2-188-64.5t-114-159.5q33 5 61 5 43 0 85-11-112-23-185.5-111.5t-73.5-205.5v-4q68 38 146 41-66-44-105-115t-39-154q0-88 44-163 121 149 294.5 238.5t371.5 99.5q-8-38-8-74 0-134 94.5-228.5t228.5-94.5q140 0 236 102 109-21 205-78-37 115-142 178 93-10 186-50z"></path>
            </svg>
        </div>

        <div class="linkedin" title="Share this on Linkedin" onclick="window.open(`https://www.linkedin.com/shareArticle?mini=true&amp;url=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware&amp;title=From%20Zero%20to%20main()%3A%20Demystifying%20Firmware%20Linker%20Scripts&amp;summary=&amp;source=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware`);">
            <svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
                <path d="M477 625v991h-330v-991h330zm21-306q1 73-50.5 122t-135.5 49h-2q-82 0-132-49t-50-122q0-74 51.5-122.5t134.5-48.5 133 48.5 51 122.5zm1166 729v568h-329v-530q0-105-40.5-164.5t-126.5-59.5q-63 0-105.5 34.5t-63.5 85.5q-11 30-11 81v553h-329q2-399 2-647t-1-296l-1-48h329v144h-2q20-32 41-56t56.5-52 87-43.5 114.5-15.5q171 0 275 113.5t104 332.5z"></path>
            </svg>
        </div>

        <div class="reddit" title="Share this on Reddit" onclick="window.open(`http://www.reddit.com/submit?url=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware&amp;title=From%20Zero%20to%20main()%3A%20Demystifying%20Firmware%20Linker%20Scripts&amp;summary=&amp;source=`, 'newwindow');">
            <svg id="Bold" enable-background="new 0 0 24 24" height="512" viewbox="0 0 24 24" width="512" xmlns="http://www.w3.org/2000/svg">
                <path d="m21.325 9.308c-.758 0-1.425.319-1.916.816-1.805-1.268-4.239-2.084-6.936-2.171l1.401-6.406 4.461 1.016c0 1.108.89 2.013 1.982 2.013 1.113 0 2.008-.929 2.008-2.038s-.889-2.038-2.007-2.038c-.779 0-1.451.477-1.786 1.129l-4.927-1.108c-.248-.067-.491.113-.557.365l-1.538 7.062c-2.676.113-5.084.928-6.895 2.197-.491-.518-1.184-.837-1.942-.837-2.812 0-3.733 3.829-1.158 5.138-.091.405-.132.837-.132 1.268 0 4.301 4.775 7.786 10.638 7.786 5.888 0 10.663-3.485 10.663-7.786 0-.431-.045-.883-.156-1.289 2.523-1.314 1.594-5.115-1.203-5.117zm-15.724 5.41c0-1.129.89-2.038 2.008-2.038 1.092 0 1.983.903 1.983 2.038 0 1.109-.89 2.013-1.983 2.013-1.113.005-2.008-.904-2.008-2.013zm10.839 4.798c-1.841 1.868-7.036 1.868-8.878 0-.203-.18-.203-.498 0-.703.177-.18.491-.18.668 0 1.406 1.463 6.07 1.488 7.537 0 .177-.18.491-.18.668 0 .207.206.207.524.005.703zm-.041-2.781c-1.092 0-1.982-.903-1.982-2.011 0-1.129.89-2.038 1.982-2.038 1.113 0 2.008.903 2.008 2.038-.005 1.103-.895 2.011-2.008 2.011z"></path>
            </svg>
        </div>

        <div class="mail" title="Share this through Email" onclick="window.open('mailto:?&amp;body=https://interrupt.memfault.com//blog/how-to-write-linker-scripts-for-firmware');">
            <svg viewbox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
                <path d="M1792 710v794q0 66-47 113t-113 47h-1472q-66 0-113-47t-47-113v-794q44 49 101 87 362 246 497 345 57 42 92.5 65.5t94.5 48 110 24.5h2q51 0 110-24.5t94.5-48 92.5-65.5q170-123 498-345 57-39 100-87zm0-294q0 79-49 151t-122 123q-376 261-468 325-10 7-42.5 30.5t-54 38-52 32.5-57.5 27-50 9h-2q-23 0-50-9t-57.5-27-52-32.5-54-38-42.5-30.5q-91-64-262-182.5t-205-142.5q-62-42-117-115.5t-55-136.5q0-78 41.5-130t118.5-52h1472q65 0 112.5 47t47.5 113z"></path>
            </svg>
        </div>
    </div>
</div>
        </aside>
      </div>

        <!-- Pagination links -->
        

        
    </div>

        <!-- Footer -->
        <footer class="footer">
  <div class="footer-links">
    <a href="https://interrupt.memfault.com/feed.xml">
      <svg class="svg-icon orange"><use xlink:href="/img/social-icons.svg#rss"></use></svg><span>RSS</span>
    </a>    
    <a href="https://interrupt-slack.herokuapp.com/" target="_blank">
      <svg class="svg-icon slack"><use xlink:href="/img/social-icons.svg#slack"></use></svg><span>Slack</span>
    </a>    
    <a href="https://go.memfault.com/interrupt-subscribe" target="_blank">Subscribe</a>    
    <a href="/contributing">Contribute</a>    
    <a href="https://community.memfault.com" target="_blank">Community</a>    
    <a href="https://memfault.com" target="_blank">Memfault.com</a>    
  </div>
  <div>© 2021 - Memfault, Inc.</div>
</footer>


        <!-- Script -->
        <script src="/js/main.js"></script>

<!-- Start of HubSpot Embed Code -->
<script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/8551838.js"></script>
<!-- End of HubSpot Embed Code -->


  </div>
</body>
</html>
